<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>睡眠＆気分ログ</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f9f9f9;
      padding: 20px;
    }
    textarea, input[type="range"] {
      width: 100%;
      margin-bottom: 10px;
    }
    button {
      padding: 8px 14px;
      font-size: 14px;
      margin-right: 8px;
    }
    ul {
      margin-top: 20px;
      padding-left: 20px;
    }
    li {
      margin-bottom: 10px;
      white-space: pre-line;
    }
    .mood-label {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 5px;
    }
    .log-entry {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      background: white;
    }
  </style>
</head>
<body>
  <h1>🛌 睡眠＆気分ログ</h1>

  <textarea id="log" placeholder="昨夜の睡眠についてメモ..."></textarea>

  <div class="mood-label">
    <span>😔 鬱（1）</span><span>🧘 安定（3）</span><span>😄 躁（5）</span>
  </div>
  <input type="range" id="mood" min="1" max="5" value="3" />

  <button onclick="saveLog()" id="saveBtn">保存</button>
  <button onclick="updateLog()" style="display:none;" id="updateBtn">更新</button>
  <button onclick="downloadLogs()">テキストで保存</button>

  <h2>📅 過去のログ</h2>
  <ul id="logList"></ul>

  <script>
    const logList = document.getElementById("logList");
    const updateBtn = document.getElementById("updateBtn");
    const saveBtn = document.getElementById("saveBtn");
    const logElem = document.getElementById("log");
    const moodElem = document.getElementById("mood");

    let editingIndex = null;

    // ページ読み込み時に必ず入力欄を有効化＆フォーカス
    window.onload = () => {
      enableInput();
    };

    function enableInput() {
      logElem.disabled = false;
      logElem.readOnly = false;
      moodElem.disabled = false;
      logElem.style.opacity = '1';
      logElem.style.visibility = 'visible';
      logElem.style.pointerEvents = 'auto';
      logElem.style.position = 'static';
      logElem.focus();
    }

    function saveLog() {
      const log = logElem.value.trim();
      const mood = moodElem.value;
      if (!log) return;

      const date = new Date().toLocaleString();
      const item = { date, mood, log };

      let logs = JSON.parse(localStorage.getItem("sleepLogs") || "[]");
      logs.push(item);
      localStorage.setItem("sleepLogs", JSON.stringify(logs));

      resetForm();
      showLogs();
    }

    function updateLog() {
      const log = logElem.value.trim();
      const mood = moodElem.value;
      if (editingIndex === null || !log) return;

      let logs = JSON.parse(localStorage.getItem("sleepLogs") || "[]");
      logs[editingIndex].log = log;
      logs[editingIndex].mood = mood;
      localStorage.setItem("sleepLogs", JSON.stringify(logs));

      resetForm();
      showLogs();
    }

    function deleteLog(index) {
      let logs = JSON.parse(localStorage.getItem("sleepLogs") || "[]");
      logs.splice(index, 1);
      localStorage.setItem("sleepLogs", JSON.stringify(logs));
      if (editingIndex === index) resetForm();
      showLogs();
    }

    function editLog(index) {
      const logs = JSON.parse(localStorage.getItem("sleepLogs") || "[]");
      const entry = logs[index];
      logElem.value = entry.log;
      moodElem.value = entry.mood;
      editingIndex = index;
      saveBtn.style.display = "none";
      updateBtn.style.display = "inline-block";

      // ここで強制的に入力可能＆フォーカスを当てる
      enableInput();
    }

    function resetForm() {
      logElem.value = "";
      moodElem.value = 3;
      editingIndex = null;
      saveBtn.style.display = "inline-block";
      updateBtn.style.display = "none";

      enableInput();
    }

    function showLogs() {
      logList.innerHTML = "";
      const logs = JSON.parse(localStorage.getItem("sleepLogs") || "[]");
      logs.slice().reverse().forEach((entry, i) => {
        const realIndex = logs.length - 1 - i;
        const li = document.createElement("li");
        li.className = "log-entry";
        li.innerHTML = `
          <strong>${entry.date}</strong> | 気分: ${entry.mood} / 5<br>
          ${entry.log}<br><br>
          <button onclick="editLog(${realIndex})">✏️ 編集</button>
          <button onclick="deleteLog(${realIndex})" style="color:red;">🗑️ 削除</button>
        `;
        logList.appendChild(li);
      });
    }

    function downloadLogs() {
      const logs = JSON.parse(localStorage.getItem("sleepLogs") || "[]");
      const text = logs.map(entry => `${entry.date} | 気分: ${entry.mood} / 5\n${entry.log}`).join('\n\n');
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "sleep_mood_logs.txt";
      a.click();

      URL.revokeObjectURL(url);
    }

    showLogs();
  </script>
</body>
</html>
