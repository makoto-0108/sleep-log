<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>睡眠・気分ログアプリ（編集・削除・CSV出力付き）</title>
<style>
  body {
    font-family: sans-serif;
    padding: 20px;
  }
  input, select, textarea, button {
    display: block;
    margin-bottom: 10px;
    padding: 5px;
    width: 200px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    word-break: break-word;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    vertical-align: top;
    text-align: center;
  }
  th {
    background: #f0f0f0;
  }
  button {
    width: auto;
    margin-right: 5px;
  }
  pre {
    white-space: pre-wrap;
    margin: 0;
  }
</style>
</head>
<body>
<div id="password-screen" style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:#000000cc; display:flex; justify-content:center; align-items:center; z-index:9999;">
  <div style="background:#fff; padding:20px; border-radius:8px; text-align:center; width:280px;">
    <h2>パスワードを入力してください</h2>
    <input type="password" id="password-input" maxlength="4" style="font-size:24px; text-align:center; width:100%; padding:8px;" autofocus>
    <button id="password-submit" style="margin-top:12px; padding:10px 20px; font-size:18px; cursor:pointer;">ログイン</button>
    <p id="error-message" style="color:red; margin-top:10px; display:none;">パスワードが違います</p>
  </div>
</div>

  <h1>睡眠・気分ログアプリ</h1>

  <form id="sleepForm">
    <input type="hidden" id="editIndex" value="-1" />
    <label>🗓 日付:
      <input type="date" id="date" required />
    </label>
    <label>🛏 就寝時間:
      <input type="time" id="sleepTime" required />
    </label>
    <label>💊 眠剤の種類・量（任意）:
      <input type="text" id="medicine" />
    </label>
    <label>🌃 中途覚醒:
      <select id="wokeUp">
        <option value="なし">なし</option>
        <option value="あり">あり</option>
      </select>
    </label>
    <label>⏰ 起床時間:
      <input type="time" id="wakeTime" required />
    </label>
    <label>😌 今日の気分（1〜5）:
      <input type="number" id="mood" min="1" max="5" required />
    </label>
    <label for="memo">📝 今日のメモ（自由記述）:
      <textarea id="memo" rows="4" cols="40" placeholder="例：眠気がある"></textarea>
    </label>
    <button type="submit">記録</button>
    <button type="button" id="cancelEdit" style="display:none;">編集キャンセル</button>
  </form>

  <button id="exportCsvBtn" type="button" style="margin-top:20px;">CSVでエクスポート</button>

  <table id="logTable">
    <thead>
      <tr>
        <th>日付</th>
        <th>就寝時間</th>
        <th>眠剤</th>
        <th>中途覚醒</th>
        <th>起床時間</th>
        <th>今日の気分</th>
        <th>メモ</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
    const passwordScreen = document.getElementById('password-screen');
const passwordInput = document.getElementById('password-input');
const passwordSubmit = document.getElementById('password-submit');
const errorMessage = document.getElementById('error-message');

const correctPassword = '1234'; // ここに好きな4桁パスワードを入れてね

passwordSubmit.addEventListener('click', () => {
  if (passwordInput.value === correctPassword) {
    passwordScreen.style.display = 'none';
  } else {
    errorMessage.style.display = 'block';
  }
});

  const form = document.getElementById('sleepForm');
  const editIndexInput = document.getElementById('editIndex');
  const logTableBody = document.querySelector('#logTable tbody');
  const cancelEditBtn = document.getElementById('cancelEdit');
  const exportCsvBtn = document.getElementById('exportCsvBtn');

  const storageKey = 'sleepLogs';

  function loadLogs() {
    return JSON.parse(localStorage.getItem(storageKey) || '[]');
  }

  function saveLogs(logs) {
    localStorage.setItem(storageKey, JSON.stringify(logs));
  }

  function renderLogs(logs) {
    logTableBody.innerHTML = '';
    logs.forEach((log, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${log.date}</td>
        <td>${log.sleepTime}</td>
        <td>${log.medicine || ''}</td>
        <td>${log.wokeUp}</td>
        <td>${log.wakeTime}</td>
        <td>${log.mood}</td>
        <td><pre>${log.memo || ''}</pre></td>
        <td>
          <button type="button" onclick="editLog(${index})">編集</button>
          <button type="button" onclick="deleteLog(${index})">削除</button>
        </td>
      `;
      logTableBody.appendChild(tr);
    });
  }

  function clearForm() {
    form.reset();
    editIndexInput.value = -1;
    cancelEditBtn.style.display = 'none';
  }

  form.addEventListener('submit', e => {
    e.preventDefault();
    const logs = loadLogs();
    const editIndex = parseInt(editIndexInput.value, 10);

    const entry = {
      date: form.date.value,
      sleepTime: form.sleepTime.value,
      medicine: form.medicine.value,
      wokeUp: form.wokeUp.value,
      wakeTime: form.wakeTime.value,
      mood: form.mood.value,
      memo: form.memo.value
    };

    if (editIndex >= 0) {
      logs[editIndex] = entry;
    } else {
      logs.unshift(entry);
    }

    saveLogs(logs);
    renderLogs(logs);
    clearForm();
  });

  window.editLog = function(index) {
    const logs = loadLogs();
    const log = logs[index];
    form.date.value = log.date;
    form.sleepTime.value = log.sleepTime;
    form.medicine.value = log.medicine;
    form.wokeUp.value = log.wokeUp;
    form.wakeTime.value = log.wakeTime;
    form.mood.value = log.mood;
    form.memo.value = log.memo;
    editIndexInput.value = index;
    cancelEditBtn.style.display = 'inline-block';
  };

  window.deleteLog = function(index) {
    if (!confirm('この記録を削除してもよろしいですか？')) return;
    const logs = loadLogs();
    logs.splice(index, 1);
    saveLogs(logs);
    renderLogs(logs);
    clearForm();
  };

  cancelEditBtn.addEventListener('click', () => {
    clearForm();
  });

  exportCsvBtn.addEventListener('click', () => {
    const logs = loadLogs();
    if (logs.length === 0) {
      alert('記録がありません');
      return;
    }

    const header = ['日付', '就寝時間', '眠剤', '中途覚醒', '起床時間', '今日の気分', 'メモ'];
    const csvRows = [
      header.join(','),
      ...logs.map(log => [
        log.date,
        log.sleepTime,
        `"${log.medicine || ''}"`,
        log.wokeUp,
        log.wakeTime,
        log.mood,
        `"${(log.memo || '').replace(/"/g, '""')}"`
      ].join(','))
    ];
    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sleep_logs.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  // 初期表示
  renderLogs(loadLogs());
</script>
</body>
</html>
