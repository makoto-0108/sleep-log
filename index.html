<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ç¡çœ ãƒ»æ°—åˆ†ãƒ­ã‚°ã‚¢ãƒ—ãƒªï¼ˆç·¨é›†ãƒ»å‰Šé™¤ãƒ»CSVå‡ºåŠ›ä»˜ãï¼‰</title>
<style>
  body {
    font-family: sans-serif;
    padding: 20px;
  }
  input, select, textarea, button {
    display: block;
    margin-bottom: 10px;
    padding: 5px;
    width: 200px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    word-break: break-word;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    vertical-align: top;
    text-align: center;
  }
  th {
    background: #f0f0f0;
  }
  button {
    width: auto;
    margin-right: 5px;
  }
  pre {
    white-space: pre-wrap;
    margin: 0;
  }
</style>
</head>
<body>
<div id="password-screen" style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:#000000cc; display:flex; justify-content:center; align-items:center; z-index:9999;">
  <div style="background:#fff; padding:20px; border-radius:8px; text-align:center; width:280px;">
    <h2>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
    <input type="password" id="password-input" maxlength="4" style="font-size:24px; text-align:center; width:100%; padding:8px;" autofocus>
    <button id="password-submit" style="margin-top:12px; padding:10px 20px; font-size:18px; cursor:pointer;">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <p id="error-message" style="color:red; margin-top:10px; display:none;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</p>
  </div>
</div>

  <h1>ç¡çœ ãƒ»æ°—åˆ†ãƒ­ã‚°ã‚¢ãƒ—ãƒª</h1>

  <form id="sleepForm">
    <input type="hidden" id="editIndex" value="-1" />
    <label>ğŸ—“ æ—¥ä»˜:
      <input type="date" id="date" required />
    </label>
    <label>ğŸ› å°±å¯æ™‚é–“:
      <input type="time" id="sleepTime" required />
    </label>
    <label>ğŸ’Š çœ å‰¤ã®ç¨®é¡ãƒ»é‡ï¼ˆä»»æ„ï¼‰:
      <input type="text" id="medicine" />
    </label>
    <label>ğŸŒƒ ä¸­é€”è¦šé†’:
      <select id="wokeUp">
        <option value="ãªã—">ãªã—</option>
        <option value="ã‚ã‚Š">ã‚ã‚Š</option>
      </select>
    </label>
    <label>â° èµ·åºŠæ™‚é–“:
      <input type="time" id="wakeTime" required />
    </label>
    <label>ğŸ˜Œ ä»Šæ—¥ã®æ°—åˆ†ï¼ˆ1ã€œ5ï¼‰:
      <input type="number" id="mood" min="1" max="5" required />
    </label>
    <label for="memo">ğŸ“ ä»Šæ—¥ã®ãƒ¡ãƒ¢ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰:
      <textarea id="memo" rows="4" cols="40" placeholder="ä¾‹ï¼šçœ æ°—ãŒã‚ã‚‹"></textarea>
    </label>
    <button type="submit">è¨˜éŒ²</button>
    <button type="button" id="cancelEdit" style="display:none;">ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </form>

  <button id="exportCsvBtn" type="button" style="margin-top:20px;">CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>

  <table id="logTable">
    <thead>
      <tr>
        <th>æ—¥ä»˜</th>
        <th>å°±å¯æ™‚é–“</th>
        <th>çœ å‰¤</th>
        <th>ä¸­é€”è¦šé†’</th>
        <th>èµ·åºŠæ™‚é–“</th>
        <th>ä»Šæ—¥ã®æ°—åˆ†</th>
        <th>ãƒ¡ãƒ¢</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
    const passwordScreen = document.getElementById('password-screen');
const passwordInput = document.getElementById('password-input');
const passwordSubmit = document.getElementById('password-submit');
const errorMessage = document.getElementById('error-message');

const correctPassword = '1234'; // ã“ã“ã«å¥½ããª4æ¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ã­

passwordSubmit.addEventListener('click', () => {
  if (passwordInput.value === correctPassword) {
    passwordScreen.style.display = 'none';
  } else {
    errorMessage.style.display = 'block';
  }
});

  const form = document.getElementById('sleepForm');
  const editIndexInput = document.getElementById('editIndex');
  const logTableBody = document.querySelector('#logTable tbody');
  const cancelEditBtn = document.getElementById('cancelEdit');
  const exportCsvBtn = document.getElementById('exportCsvBtn');

  const storageKey = 'sleepLogs';

  function loadLogs() {
    return JSON.parse(localStorage.getItem(storageKey) || '[]');
  }

  function saveLogs(logs) {
    localStorage.setItem(storageKey, JSON.stringify(logs));
  }

  function renderLogs(logs) {
    logTableBody.innerHTML = '';
    logs.forEach((log, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${log.date}</td>
        <td>${log.sleepTime}</td>
        <td>${log.medicine || ''}</td>
        <td>${log.wokeUp}</td>
        <td>${log.wakeTime}</td>
        <td>${log.mood}</td>
        <td><pre>${log.memo || ''}</pre></td>
        <td>
          <button type="button" onclick="editLog(${index})">ç·¨é›†</button>
          <button type="button" onclick="deleteLog(${index})">å‰Šé™¤</button>
        </td>
      `;
      logTableBody.appendChild(tr);
    });
  }

  function clearForm() {
    form.reset();
    editIndexInput.value = -1;
    cancelEditBtn.style.display = 'none';
  }

  form.addEventListener('submit', e => {
    e.preventDefault();
    const logs = loadLogs();
    const editIndex = parseInt(editIndexInput.value, 10);

    const entry = {
      date: form.date.value,
      sleepTime: form.sleepTime.value,
      medicine: form.medicine.value,
      wokeUp: form.wokeUp.value,
      wakeTime: form.wakeTime.value,
      mood: form.mood.value,
      memo: form.memo.value
    };

    if (editIndex >= 0) {
      logs[editIndex] = entry;
    } else {
      logs.unshift(entry);
    }

    saveLogs(logs);
    renderLogs(logs);
    clearForm();
  });

  window.editLog = function(index) {
    const logs = loadLogs();
    const log = logs[index];
    form.date.value = log.date;
    form.sleepTime.value = log.sleepTime;
    form.medicine.value = log.medicine;
    form.wokeUp.value = log.wokeUp;
    form.wakeTime.value = log.wakeTime;
    form.mood.value = log.mood;
    form.memo.value = log.memo;
    editIndexInput.value = index;
    cancelEditBtn.style.display = 'inline-block';
  };

  window.deleteLog = function(index) {
    if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    const logs = loadLogs();
    logs.splice(index, 1);
    saveLogs(logs);
    renderLogs(logs);
    clearForm();
  };

  cancelEditBtn.addEventListener('click', () => {
    clearForm();
  });

  exportCsvBtn.addEventListener('click', () => {
    const logs = loadLogs();
    if (logs.length === 0) {
      alert('è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    const header = ['æ—¥ä»˜', 'å°±å¯æ™‚é–“', 'çœ å‰¤', 'ä¸­é€”è¦šé†’', 'èµ·åºŠæ™‚é–“', 'ä»Šæ—¥ã®æ°—åˆ†', 'ãƒ¡ãƒ¢'];
    const csvRows = [
      header.join(','),
      ...logs.map(log => [
        log.date,
        log.sleepTime,
        `"${log.medicine || ''}"`,
        log.wokeUp,
        log.wakeTime,
        log.mood,
        `"${(log.memo || '').replace(/"/g, '""')}"`
      ].join(','))
    ];
    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sleep_logs.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  // åˆæœŸè¡¨ç¤º
  renderLogs(loadLogs());
</script>
</body>
</html>
